<app-layout>
  <div class="main">
    <section class="page-banner d-grid place-items-center">
      <div class="hero-slideshow" aria-hidden="false">
        <div class="slides">
          <!-- Images referenced from assets/TOURIST-PLACES (can be adjusted in the component TS) -->
          <img
            *ngFor="let img of heroImages; let i = index"
            [src]="img"
            [class.active]="i === activeSlide"
            class="slide-img"
            alt="Tourist place image {{ i + 1 }}"
          />
        </div>

        <!-- Overlay title -->
        <div class="hero-overlay">
          <h1 class="display-4 text-center">Book Tourist Spots</h1>
        </div>

        <!-- Dots / manual navigation -->
        <div class="hero-dots">
          <button
            *ngFor="let img of heroImages; let i = index"
            class="dot"
            [class.active]="i === activeSlide"
            (click)="goToSlide(i)"
            [attr.aria-label]="'Show slide ' + (i + 1)"
          ></button>
        </div>
      </div>
    </section>

    <div class="container my-5">
      <div class="row justify-content-between">
        <!-- Left Side - Booking Summary (25%) -->
        <div class="col-md-4 booking-summary-col">
          <ng-template #bookingSummaryContent>
            <ng-container *ngIf="bookedSpots.length > 0; else noBookings">
              <hr class="my-2" />
              <!-- Booked spots list -->
              <div class="booked-spots">
                <div
                  *ngFor="let spot of bookedSpots; let i = index"
                  class="booked-spot mb-3"
                >
                  <div
                    class="d-flex justify-content-between align-items-start mb-2"
                  >
                    <h6 class="mb-1">{{ spot.name }}</h6>
                    <button
                      class="btn btn-sm btn-outline-danger"
                      (click)="removeSpot(i)"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>

                  <div class="fee-breakdown small">
                    <!-- Entry Fee -->
                    <div class="d-flex justify-content-between align-items-center mb-2" *ngIf="spot.breakdown.entry > 0">
                      <div class="d-flex align-items-center gap-2">
                        <span>Entry Fee: ₹{{ spot.unitPrices.entry }} ×</span>
                        <div class="stepper-control d-flex align-items-center border rounded bg-white">
                          <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                  (click)="decrementSpotCount(i, 'adults')"
                                  [disabled]="spot.counts.adults <= 1">-</button>
                          <span class="px-2 font-weight-bold">{{ spot.counts.adults }}</span>
                          <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                  (click)="incrementSpotCount(i, 'adults')">+</button>
                        </div>
                        <span>people</span>
                      </div>
                      <span>₹{{ spot.breakdown.entry }}</span>
                    </div>

                    <!-- Parking -->
                    <ng-container *ngIf="spot.breakdown.parking > 0 || spot.unitPrices.parking > 0 || spot.unitPrices.parkingTwoWheeler !== undefined">
                      <!-- Split Parking: 2 Wheeler -->
                      <div class="d-flex justify-content-between align-items-center mb-2" *ngIf="spot.unitPrices.parkingTwoWheeler !== undefined">
                        <div class="d-flex align-items-center gap-2">
                          <span>2 Wheeler: ₹{{ spot.unitPrices.parkingTwoWheeler }} ×</span>
                          <div class="stepper-control d-flex align-items-center border rounded bg-white">
                            <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                    (click)="decrementSpotCount(i, 'twoWheelers')"
                                    [disabled]="!spot.counts.twoWheelers || spot.counts.twoWheelers <= 0">-</button>
                            <span class="px-2 font-weight-bold">{{ spot.counts.twoWheelers || 0 }}</span>
                            <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                    (click)="incrementSpotCount(i, 'twoWheelers')">+</button>
                          </div>
                        </div>
                        <span>₹{{ (spot.unitPrices.parkingTwoWheeler || 0) * (spot.counts.twoWheelers || 0) }}</span>
                      </div>

                      <!-- Split Parking: 4 Wheeler -->
                      <div class="d-flex justify-content-between align-items-center mb-2" *ngIf="spot.unitPrices.parkingFourWheeler !== undefined">
                        <div class="d-flex align-items-center gap-2">
                          <span>4 Wheeler: ₹{{ spot.unitPrices.parkingFourWheeler }} ×</span>
                          <div class="stepper-control d-flex align-items-center border rounded bg-white">
                            <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                    (click)="decrementSpotCount(i, 'fourWheelers')"
                                    [disabled]="!spot.counts.fourWheelers || spot.counts.fourWheelers <= 0">-</button>
                            <span class="px-2 font-weight-bold">{{ spot.counts.fourWheelers || 0 }}</span>
                            <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                    (click)="incrementSpotCount(i, 'fourWheelers')">+</button>
                          </div>
                        </div>
                        <span>₹{{ (spot.unitPrices.parkingFourWheeler || 0) * (spot.counts.fourWheelers || 0) }}</span>
                      </div>

                      <!-- Generic Parking -->
                      <div class="d-flex justify-content-between align-items-center mb-2" 
                           *ngIf="spot.unitPrices.parkingTwoWheeler === undefined && spot.unitPrices.parking > 0">
                        <div class="d-flex align-items-center gap-2">
                          <span>Parking: ₹{{ spot.unitPrices.parking }} ×</span>
                          <div class="stepper-control d-flex align-items-center border rounded bg-white">
                            <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                    (click)="decrementSpotCount(i, 'vehicles')"
                                    [disabled]="spot.counts.vehicles <= 0">-</button>
                            <span class="px-2 font-weight-bold">{{ spot.counts.vehicles }}</span>
                            <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                    (click)="incrementSpotCount(i, 'vehicles')">+</button>
                          </div>
                          <span>vehicles</span>
                        </div>
                        <span>₹{{ spot.breakdown.parking }}</span>
                      </div>
                    </ng-container>

                    <!-- Camera -->
                    <div class="d-flex justify-content-between align-items-center mb-2" *ngIf="spot.unitPrices.camera > 0">
                      <div class="d-flex align-items-center gap-2">
                        <span>Camera: ₹{{ spot.unitPrices.camera }} ×</span>
                        <div class="stepper-control d-flex align-items-center border rounded bg-white">
                          <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                  (click)="decrementSpotCount(i, 'cameras')"
                                  [disabled]="spot.counts.cameras <= 0">-</button>
                          <span class="px-2 font-weight-bold">{{ spot.counts.cameras }}</span>
                          <button class="btn btn-sm btn-link text-decoration-none px-2 py-0 text-dark" 
                                  (click)="incrementSpotCount(i, 'cameras')">+</button>
                        </div>
                        <span>cameras</span>
                      </div>
                      <span>₹{{ spot.breakdown.camera }}</span>
                    </div>

                    <!-- Add-ons -->
                    <div class="d-flex justify-content-between" *ngIf="spot.breakdown.addOns > 0">
                      <span>Add-ons</span>
                      <span>₹{{ spot.breakdown.addOns }}</span>
                    </div>

                    <hr class="my-2" />
                    <div class="d-flex justify-content-between fw-bold">
                      <span>Spot Total:</span>
                      <span>₹{{ spot.total }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Grand Total -->
              <div
                class="d-flex justify-content-between border-top border-bottom border-primary py-2 font-weight-bold text-secondary h5"
              >
                <span class="mb-0">Grand Total</span>
                <span>₹{{ grandTotal }}</span>
              </div>
            </ng-container>
            <button
              mat-raised-button
              color="primary"
              class="w-100 mt-3"
              *ngIf="bookedSpots.length > 0"
              (click)="proceedToCheckout()"
            >
              Proceed
            </button>
          </ng-template>

          <!-- Desktop Layout -->
          <div
            *ngIf="!isMobile"
            class="booking-summary-bar text-dark rounded-3 p-3"
            style="background-color: #e6ffcc;"
          >
            <h4 class="m-0 pb-1 font-weight-bold">Booking Summary</h4>
            <ng-container
              *ngTemplateOutlet="bookingSummaryContent"
            ></ng-container>
          </div>

          <!-- Mobile Layout -->
          <mat-accordion *ngIf="isMobile">
            <div class="mt-2">
              <mat-expansion-panel
                (opened)="panelOpenState = true"
                (closed)="panelOpenState = false"
              >
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <h5 class="m-0 font-weight-bold" [class.booking-summary-bar--title]="isSpotsAvailable()">
                      Booking Summary
                    </h5>
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <div [ngClass]="{ 'accordion-body': bookedSpots.length > 0 }">
                  <ng-container
                    *ngTemplateOutlet="bookingSummaryContent"
                  ></ng-container>
                </div>
              </mat-expansion-panel>
            </div>
          </mat-accordion>

          <ng-template #noBookings>
            <div
              class="d-flex my-2 p-3 align-items-center justify-content-around"
            >
              <i class="fa fa-plus" aria-hidden="true"></i>
              <p class="m-0">Add your preferred tourist spot</p>
            </div>
          </ng-template>
        </div>
        <!-- Middle - Tourist Spot Selection (wider) -->
        <div class="col-md-8">
          <div class="tourist-spots-list">
            <!-- No Results Message -->
            <div
              *ngIf="filteredCategories.length === 0 || !hasAnySpots()"
              class="alert alert-info"
            >
              <i class="fa-solid fa-info-circle me-2"></i>
              No tourist spots match your selected filters. Try adjusting your
              filter criteria.
            </div>

            <!-- Filtered Categories -->
            <div *ngFor="let category of filteredCategories" class="mb-5">
              <div
                class="d-flex align-items-center mb-3"
                *ngIf="category.spots.length > 0"
              >
                <h2 class="h4 mb-0">
                  {{ category.icon }} {{ category.title }}
                </h2>
                <div
                  class="flex-grow-1 border-top ms-3"
                  style="opacity: 0.3"
                ></div>
              </div>
              <div
                *ngFor="let spot of category.spots"
                class="tourist-spot-card mb-4"
                [attr.id]="spot.id"
              >
                <div class="card shadow-sm">
                  <div class="card-body">
                    <app-tourist-spot-selection
                      [name]="spot.name"
                      [location]="spot.location"
                      [type]="spot.typeLabel"
                      [category]="spot.category"
                      [images]="spot.images"
                      [fees]="spot.fees"
                      [addOns]="spot.addOns"
                      [detailsLink]="['/tourist-destination']"
                      [detailsFragment]="spot.detailsFragment || spot.id"
                      [openInNewTab]="true"
                      [ticketsLeftToday]="spot.ticketsLeftToday"
                      [isSoldOut]="spot.ticketsLeftToday === 0"
                      [difficulty]="spot.difficulty"
                      [distance]="spot.distanceKm"
                      [elevationGain]="spot.elevationGainM"
                      (addToBooking)="onAddTouristBooking($event, spot.id)"
                    >
                    </app-tourist-spot-selection>
                    <div
                      *ngIf="spot.category === 'Trek'"
                      class="small text-muted mt-2 d-flex flex-wrap gap-3"
                    >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-layout>
