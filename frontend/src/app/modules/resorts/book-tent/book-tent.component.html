<app-layout>
  <div class="main">
    <app-loader *ngIf="false"></app-loader>
    <section class="page-banner d-grid place-items-center" *ngIf="selectedResortInfo">
      <h1 class="display-3 text-center">{{ selectedResortInfo.title }}</h1>
    </section>

    <div class="container-fluid">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a routerLink="/home">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ selectedResortInfo?.title }}</li>
        </ol>
      </nav>

      <div class="row" *ngIf="selectedResortInfo">
        <div class="col-md-4">
          <div class="map-container" *ngIf="resortKey === 'vanavihari'">
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d15212.133581651236!2d81.712357!3d17.601149!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3a373b5d52758873%3A0x718f2b2059db5e0a!2sVanavihari%20Maredumilli!5e0!3m2!1sen!2sin!4v1708738599849!5m2!1sen!2sin"
              width="400" height="300" style="border: 0" allowfullscreen="" loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
          <div class="map-container" *ngIf="resortKey === 'karthikavanm'">
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3802.321273036429!2d81.63047557463233!3d17.634936395627708!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3a3725b319b638ff%3A0x6497bd032f830606!2sJUNGLE%20STAR%20ECO%20CAMP!5e0!3m2!1sen!2sin!4v1708782328839!5m2!1sen!2sin"
              width="600" height="450" style="border: 0" allowfullscreen="" loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
        </div>
        <div class="col-md-8 mt-4 mt-lg-0">
          <h4>About {{ selectedResortInfo.title }}</h4>
          <p>{{ selectedResortInfo.about }}</p>
        </div>
      </div>

      <div class="policy-section row py-3" *ngIf="selectedResortInfo">
        <div class="col-md-3">
          <h4 class="">Guest Policies & Accommodation</h4>
          <ul>
            <li><strong>Occupancy:</strong> 2 guests (for 2-person tent), 4 guests (for 4-person tent)</li>
          </ul>
        </div>
        <div class="col-md-3">
          <h4 class="custom-h4">Cancellation</h4>
          <ul>
            <li><strong> More than 48 hours:</strong> 90% refund</li>
            <li><strong> 24-48 hours before:</strong> 80% refund</li>
            <li><strong> Within 24 hours:</strong> No refund</li>
          </ul>
        </div>
        <div class="col-md-3">
          <h4 class="custom-h4">Check-In/Out:</h4>
          <ul>
            <li><strong>Check-in:</strong> 10:00 AM IST</li>
            <li><strong> Check-out:</strong> 9:00 AM IST</li>
          </ul>
        </div>
        <div class="col-md-3">
          <h4 class="">Common Amenities:</h4>
          <ul>
            <li>1 DECATLON TENT</li>
            <li>1-HANING LIGHT led</li>
            <li>1-CENTER TABLE</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container mt-3">
      <h2 class="text-center mb-3 mt-5">Search availability</h2>
      <app-search-resort></app-search-resort>

      <div class="row mt-3">
  <aside class="col-md-4">
          <ng-template #bookingSummaryContent>
            <ng-container *ngIf="bookedTents.length > 0; else noBookings">
              <hr class="my-2" />
              <div class="booked-spots">
                <div *ngFor="let t of bookedTents; let i = index" class="booked-spot mb-3">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-1">{{ t.name }}</h6>
                    <button class="btn btn-sm btn-outline-danger" (click)="removeTent(i)"><i class="fa-solid fa-trash"></i></button>
                  </div>
                  <div class="fee-breakdown small">
                    <div class="d-flex justify-content-between">
                      <span>Capacity: {{ t.capacity }} person</span>
                      <span>₹{{ t.price }}</span>
                    </div>
                    <hr class="my-2" />
                    <div class="d-flex justify-content-between fw-bold">
                      <span>Tent Total:</span>
                      <span>₹{{ t.total }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between border-top border-bottom border-primary py-2 font-weight-bold text-secondary h5">
                <span class="mb-0">Grand Total</span>
                <span>₹{{ grandTotal }}</span>
              </div>
            </ng-container>
            <button mat-raised-button color="primary" class="w-100 mt-3" *ngIf="bookedTents.length > 0" (click)="proceedToCheckout()">Proceed</button>
          </ng-template>

          <div *ngIf="!isMobile" class="booking-summary-bar text-dark rounded-3">
            <h4 class="mt-2 mb-0 pb-1 font-weight-bold">Booking Summary</h4>
            <ng-container *ngTemplateOutlet="bookingSummaryContent"></ng-container>
          </div>

          <mat-accordion *ngIf="isMobile">
            <div class="mt-2">
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <h5 class="m-0 font-weight-bold">Booking Summary</h5>
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <div [ngClass]="{ 'accordion-body': bookedTents.length > 0 }">
                  <ng-container *ngTemplateOutlet="bookingSummaryContent"></ng-container>
                </div>
              </mat-expansion-panel>
            </div>
          </mat-accordion>

          <ng-template #noBookings>
            <div class="d-flex my-2 p-3 align-items-center justify-content-around">
              <i class="fa fa-plus" aria-hidden="true"></i>
              <p class="m-0">Add your preferred tents</p>
            </div>
          </ng-template>
        </aside>

  <main class="rooms-listing col-md-8">
          <ng-template #loading>
            <div class="text-center">
              <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p>Loading tents...</p>
            </div>
          </ng-template>

          <div *ngIf="tents.length === 0" class="card mb-3 text-center">Sorry, tents are not available</div>

          <div *ngIf="tents.length > 0">
            <div class="card mb-3" *ngFor="let tent of tents; let ti = index">
              <div class="row">
                <div class="col-md-5">
                  <div class="containerg">
                    <div class="card-containerg" #cardContainer>
                      <div class="card py-0" *ngFor="let img of tent.images; let i = index">
                        <img class="img-responsive" [src]="img" alt="" (click)="openFullImage(img)" />
                      </div>
                    </div>
                    
                    <div class="full-image-overlay" *ngIf="isFullImageVisible" (click)="closeFullImage()">
                      <div class="full-image-container">
                        <img class="full-image" [src]="fullImageSrc" alt="" />
                        <div class="overlay-controls">
                          <button class="close-button" (click)="closeFullImage()">
                            <i class="fas fa-window-close" aria-hidden="true"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="scroll-icon left" (click)="scrollLeft(ti)">
                      <i class="fas fa-chevron-left"></i>
                    </div>
                    <div class="scroll-icon right" (click)="scrollRight(ti)">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </div>
                <div class="col-md-7 row justify-content-between">
                  <div class="col-md-8">
                    <!-- New compact tent details block -->
                    <div class="tent-details mt-2">
                      <div class="row">
                        <div class="col-12 detail-row"><strong>Tent Name:</strong> {{ tent.name || '2 Person tent' }}</div>
                        <div class="col-12 detail-row"><strong>Accommodation Type:</strong> {{ tent.accommodationType || 'Camping Tent' }}</div>
                        <div class="col-12 detail-row"><strong>Brand Name:</strong> {{ tent.brand || 'Decathlon' }}</div>
                        <div class="col-12 detail-row"><strong>Tent Base:</strong> {{ tent.tentBase || 'Concrete' }}</div>
                        <div class="col-12 detail-row"><strong>Resort:</strong> {{ selectedResortInfo?.title || 'Vanavihari' }}</div>
                      </div>
                    </div>
                    <!-- Amenities: show counts based on tent.capacity (default 2) -->
                    <div class="tent-amenities mt-2">
                      <h6 class="m-0 mb-1">Amenities</h6>
                      <div class="amenities-list">
                        <span *ngFor="let item of getAmenityItems(tent)" class="amenity-item">
                          <ng-container *ngIf="item.img; else faIcon">
                            <img class="amenity-logo" [src]="item.img" alt=""/>
                          </ng-container>
                          <ng-template #faIcon>
                            <i [class]="item.icon"></i>
                          </ng-template>
                          <span class="amenity-text">{{ item.text }}</span>
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 row d-md-block gap-2 text-md-end mt-2 mt-md-0 pe-md-0">
                        <div class="col-auto">
                          <h6 class="p-0 m-0 text-success tent-price"><strong>INR ₹{{ tent.price | number:'1.0-0' }}</strong></h6>
                          <small class="text-muted d-block tent-guests">{{ tent.capacity || 2 }} x guest</small>
                        </div>
                  </div>
                  <div class="col my-2 pe-0">
                        <button mat-raised-button color="primary" class="float-end float-md-start" (click)="addTentToBooking(tent)">Add tent</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</app-layout>
